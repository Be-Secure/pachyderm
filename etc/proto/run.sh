#!/bin/bash
set -ex

tar -C "${GOPATH}/src/github.com/pachyderm/pachyderm" -xf /dev/stdin

# Make sure the proto compiler is reasonably up-to-date so that our compiled
# protobufs aren't generated by stale tools
max_age="$(date --date="1 month ago" +%s)"
if [[ "${max_age}" -gt "$(cat /last_run_time)" ]]; then
    PRE="\e[1;31m~\e[0m"
    echo -e "\e[1;31m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\e[0m" >/dev/stderr
    echo -e "${PRE} \e[1;31mWARNING:\e[0m pachyderm_proto is out of date" >/dev/stderr
    echo -e "${PRE} please run" >/dev/stderr
    echo -e "${PRE}   make DOCKER_BUILD_FLAGS=--no-cache proto" >/dev/stderr
    echo -e "\e[1;31m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\e[0m" >/dev/stderr
    exit 1
fi

cd "${GOPATH}/src/github.com/pachyderm/pachyderm"

mkdir -p v2/src

# shellcheck disable=SC2044
protoc  --go-patch_out=plugin=go,paths=source_relative:./src \
        --go-patch_out=plugin=go-grpc,paths=source_relative:./src \
        -Isrc \
        -I /go/pkg/mod/github.com/alta/protopatch@v0.5.0 \
        src/admin/admin.proto >/dev/stderr

#pushd src > /dev/stderr
#read -ra proto_files < <(find . -name "*.proto" -print0 | xargs -0)
#protoc \
#    --proto_path . \
#    --plugin=protoc-gen-pach="${GOPATH}/bin/protoc-gen-pach" \
#    -I /go/pkg/mod/github.com/alta/protopatch@v0.5.0 \
#    --pach_out="../v2/src" \
#    admin/admin.proto  > /dev/stderr
#
#popd > /dev/stderr
#
## TODO (brendon): figure out how to configure protoc
#pushd v2 > /dev/stderr
gofmt -w src > /dev/stderr
find src -regex ".*\.go" -print0 | xargs -0 tar cf -
